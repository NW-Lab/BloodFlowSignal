# 使用方法ガイド

## 必要な環境

本プロジェクトを実行するには、以下の環境が必要です。

*   **Arduino IDE**: バージョン 2.0 以降を推奨
*   **M5Unifiedライブラリ**: M5Stack製品の統合ライブラリ
*   **ESP32ボードサポート**: Arduino IDEにESP32-S3のボードサポートを追加

## Arduino IDEの設定

### 1. ESP32ボードサポートの追加

Arduino IDEで、ESP32ボードを使用できるようにするため、以下の手順でボードマネージャーURLを追加します。

1. Arduino IDEを起動
2. 「ファイル」→「環境設定」を開く
3. 「追加のボードマネージャーのURL」に以下を追加:
   ```
   https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
   ```
4. 「OK」をクリック
5. 「ツール」→「ボード」→「ボードマネージャー」を開く
6. 検索欄に「esp32」と入力
7. 「esp32 by Espressif Systems」をインストール（バージョン 2.0.0 以降）

### 2. M5Unifiedライブラリのインストール

1. 「スケッチ」→「ライブラリをインクルード」→「ライブラリを管理」を開く
2. 検索欄に「M5Unified」と入力
3. 「M5Unified」をインストール

### 3. ボード設定

1. 「ツール」→「ボード」→「ESP32 Arduino」→「ESP32S3 Dev Module」を選択
2. 以下のパラメータを設定:
   - **USB CDC On Boot**: "Enabled"
   - **CPU Frequency**: "240MHz (WiFi)"
   - **Flash Mode**: "QIO 80MHz"
   - **Flash Size**: "8MB (64Mb)"
   - **Partition Scheme**: "8M with spiffs (3MB APP/1.5MB SPIFFS)"
   - **PSRAM**: "Disabled"
   - **Upload Speed**: "921600"

## ハードウェアの接続

以下の表に従って、M5AtomS3とICS-43434マイクを接続します。

| M5AtomS3 | ICS-43434 | 説明 |
| :--- | :--- | :--- |
| G5 | SCK | I2Sシリアルクロック |
| G6 | WS | I2Sワードセレクト |
| G7 | SD | I2Sシリアルデータ |
| 3V3 | VIN | 電源（3.3V） |
| GND | GND | グランド |
| GND | SEL | チャンネル選択（Leftチャンネル） |

**注意事項:**
*   ICS-43434は3.3V専用です。5Vを接続しないでください。
*   マイクは底面ポート（ボトムポート）なので、音孔が計測対象に向くように配置してください。

## プログラムの書き込み

1. Arduino IDEで `BloodFlow_ICS43434.ino` を開く
2. M5AtomS3をUSB-Cケーブルでパソコンに接続
3. 「ツール」→「シリアルポート」から適切なポートを選択
4. 「→」ボタン（マイコンボードに書き込む）をクリック
5. 書き込みが完了するまで待つ

**書き込みモードに入らない場合:**
M5AtomS3のリセットボタンを約2秒間長押しし、内部の緑色LEDが点灯したら離します。これでダウンロードモードに入ります。

## データの可視化

### シリアルプロッターの使用

1. Arduino IDEで「ツール」→「シリアルプロッター」を開く
2. ボーレートが「115200 baud」に設定されていることを確認
3. マイクを手首や首の動脈付近に配置
4. 波形がリアルタイムで表示されます

### 測定のコツ

*   **測定位置**: 手首の橈骨動脈、首の頸動脈など、脈拍を感じやすい場所が適しています。
*   **マイクの配置**: マイクの底面（音孔）を皮膚に軽く押し当てます。
*   **静かな環境**: 周囲の雑音が少ない環境で測定すると、より明瞭な波形が得られます。
*   **安定した保持**: マイクを動かさずに、一定の圧力で保持します。

## トラブルシューティング

### 波形が表示されない

*   配線を再確認してください。特にデータピン（SD）の接続を確認します。
*   シリアルプロッターのボーレートが115200になっているか確認してください。
*   マイクの電源（3.3V）が正しく供給されているか確認してください。

### ノイズが多い

*   マイクと皮膚の接触を安定させてください。
*   周囲の音源（ファン、エアコンなど）から離れてください。
*   配線が長すぎる場合は短くしてください。

### I2Sエラーが表示される

*   ピン番号がコード内の定義と一致しているか確認してください。
*   M5Unifiedライブラリが最新版にアップデートされているか確認してください。
*   ESP32ボードサポートが正しくインストールされているか確認してください。

## データの保存

シリアルプロッターで表示されたデータを保存したい場合は、以下の方法があります。

### 方法1: シリアルモニタでログを保存

1. 「ツール」→「シリアルモニタ」を開く
2. データが流れてくるのを確認
3. ログをコピーしてテキストファイルに保存

### 方法2: 外部ツールの使用

*   **CoolTerm**: シリアルデータをファイルに直接保存できるツール
*   **Python + pySerial**: スクリプトを書いてデータを自動保存

## 次のステップ

基本的な計測ができたら、以下のような拡張を試してみてください。

*   **FFT解析**: 周波数成分を分析して、心拍数を自動計算
*   **フィルタリング**: ローパスフィルタやバンドパスフィルタを適用してノイズを除去
*   **データロギング**: SDカードにデータを保存して、長期的な記録を取得
*   **Bluetooth送信**: 計測データをスマートフォンに送信して表示
