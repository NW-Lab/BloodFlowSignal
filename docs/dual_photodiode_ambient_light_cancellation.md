# 2個フォトダイオード方式の外光除去技術

## 概要

光学式PPGセンサーにおいて、受光部（フォトダイオード）が2個ある場合の外光除去技術について解説します。この技術は、**LED ON-OFF方式と同じ基本原理**（時間的な差分を取る）を使用しますが、**アナログ領域で電荷再分配により実現**する点が大きく異なります。

---

## 基本原理: 交互サンプリングと電荷再分配

### 動作の概要

2個フォトダイオード方式（正確には**2個電荷リザーバ方式**）では、以下の3つのフェーズで外光除去を行います。

1. **Phase 1**: LED ON時に信号をサンプリングし、電荷リザーバCrに保存
2. **Phase 2**: LED OFF時に信号をサンプリングし、電荷リザーバCaに保存
3. **Phase 3**: 2つの電荷リザーバを**逆極性で接続**し、電荷再分配により差分を取る

この方式により、外光成分が物理的に打ち消され、純粋なPPG信号のみが抽出されます。

---

## 詳細な動作原理

### Phase 1: LED ON時のサンプリング

**スイッチ状態**:
- Switch S1: 接続
- Switch S2, S3: 切断

**測定内容**: LED光（PPG信号）+ 外光

**保存先**: 電荷リザーバ Cr

**保存される電荷**:
```
Qr = Cr × V_ph1
```

ここで、`V_ph1 = V_LED + V_AL`
- `V_LED`: LED光による信号（PPG信号）
- `V_AL`: 外光による信号（ノイズ）

### Phase 2: LED OFF時のサンプリング

**スイッチ状態**:
- Switch S1: 切断
- Switch S2: 接続
- Switch S3: 切断

**測定内容**: 外光のみ

**保存先**: 電荷リザーバ Ca

**保存される電荷**:
```
Qa = Ca × V_ph2
```

ここで、`V_ph2 = V_AL`（LED OFFのため、外光のみ）

### Phase 3: 電荷再分配

**スイッチ状態**:
- Switch S1, S2: 切断
- Switch S3: 接続

**動作**: CrとCaを**逆極性で接続**

**極性制御**:
- `Polarity = High`: Crのプラスノードを Caのマイナスノードに接続
- `Polarity = Low`: Crのプラスノードを Caのプラスノードに接続

**出力電圧**（Cr = Caの場合）:
```
V_out = (V_ph1 - V_ph2) / 2
      = (V_LED + V_AL - V_AL) / 2
      = V_LED / 2
```

**結果**: 外光成分（V_AL）が完全に除去され、LED光による信号（PPG信号）のみが残ります。

---

## LED ON-OFF方式との比較

| 項目 | LED ON-OFF方式（デジタル差分） | 2個電荷リザーバ方式（アナログ差分） |
|------|---------------------------|--------------------------------|
| **基本原理** | LED ON時とOFF時の差分を取る | 同じ（時間的な差分） |
| **差分計算の場所** | デジタル演算（マイコン内） | アナログ回路（電荷再分配） |
| **外光除去のタイミング** | ADC変換後、デジタル演算で除去 | ADC変換前、アナログ段階で除去 |
| **消費電力** | 中程度（ADC + デジタル演算） | 低い（アナログ回路のみ） |
| **ダイナミックレンジ** | 外光成分がADCレンジを占有 | 外光除去後にADC変換（有効活用） |
| **精度** | ADC分解能に依存 | 電荷再分配の精度に依存 |
| **回路複雑度** | 低い（シンプル） | 中程度（スイッチ制御が必要） |
| **リアルタイム性** | デジタル演算の遅延あり | 瞬時に完了（遅延ほぼなし） |
| **実装** | マイコン + ADC | 電荷リザーバ + スイッチ + 制御回路 |

---

## 利点と欠点

### 利点

**1. 低消費電力**

アナログ領域で外光除去が完了するため、デジタル演算が不要です。これにより、消費電力を大幅に削減できます。

**実測値**: 26.4 μW（Kim et al., 2015）

**2. 高ダイナミックレンジ**

外光成分を除去してからADC変換するため、ADCのダイナミックレンジをPPG信号に集中できます。これにより、微弱なPPG信号を高精度に測定可能です。

**3. リアルタイム処理**

電荷再分配は瞬時に完了するため、リアルタイムで外光除去が可能です。遅延がほとんどありません。

**4. 高精度**

電荷再分配により、外光成分を物理的に打ち消すため、デジタル演算による丸め誤差がありません。

### 欠点

**1. 回路複雑度の増加**

2つの電荷リザーバ（コンデンサ）とスイッチ制御回路が必要です。タイミング制御が重要になります。

**2. 電荷リザーバのマッチング**

CrとCaのキャパシタンスが正確に一致している必要があります。マッチング誤差があると、外光除去が不完全になります。

**3. スイッチのリーク電流**

スイッチのリーク電流により、保存された電荷が減衰する可能性があります。高品質なスイッチ（低リーク電流 <1 pA）が必要です。

**4. 集積回路（IC）化が必要**

この技術は、通常、専用の集積回路（ASIC）として実装されます。ディスクリート部品での実装は困難です。

---

## 実装上の注意点

### 1. タイミング制御

Phase 1、Phase 2、Phase 3のタイミングを正確に制御する必要があります。

**推奨タイミング**:
- **Phase 1（LED ON）**: 4 ms
- **Phase 2（LED OFF）**: 4 ms
- **Phase 3（電荷再分配）**: 数μs～数十μs

**タイミング図**:
```
LED:     ████████________████████________
         |  ON  |  OFF  |  ON  |  OFF  |
         
Phase:   |  1   |   2   |  1   |   2   |
         
Switch:  S1 ON  S2 ON   S1 ON  S2 ON
         S3 OFF S3 OFF  S3 OFF S3 OFF
         
Charge:  Cr保存 Ca保存  Cr保存 Ca保存
         
Output:         S3 ON          S3 ON
                再分配          再分配
```

### 2. 電荷リザーバのサイズ

電荷リザーバ（Cr, Ca）のキャパシタンスは、以下の要素を考慮して決定します。

**大きいキャパシタンス（例: 10 pF以上）**:
- **利点**: ノイズ耐性が高い、リーク電流の影響が小さい
- **欠点**: チップ面積が大きい、電荷再分配に時間がかかる

**小さいキャパシタンス（例: 1 pF以下）**:
- **利点**: チップ面積が小さい、高速動作
- **欠点**: ノイズ耐性が低い、リーク電流の影響が大きい

**推奨値**: 3～10 pF（ノイズ耐性と速度のバランス）

### 3. スイッチの選択

スイッチには、低リーク電流、低オン抵抗、高速スイッチングが求められます。

**推奨スイッチ**:
- **CMOS伝送ゲート（Transmission Gate）**: NMOSとPMOSを並列接続
- **低リーク電流**: <1 pA
- **低オン抵抗**: <100 Ω
- **スイッチング時間**: <1 μs

### 4. マッチング精度

CrとCaのキャパシタンスは、高精度でマッチングする必要があります。

**推奨マッチング精度**: ±0.1%以内

**実装方法**:
- 同じレイアウト、同じサイズのキャパシタを使用
- 温度変動の影響を最小化するため、温度係数の小さいキャパシタを選択

---

## 本プロジェクトでの適用可能性

### 使用予定の光学式センサー

**製品**: [秋月電子 光学式脈波センサー](https://akizukidenshi.com/catalog/g/g116107/)

このセンサーは、既製品のモジュールであり、内部回路の詳細は不明です。おそらく、以下のいずれかの方式を使用していると推定されます。

1. **LED ON-OFF方式（デジタル差分）**: 最も一般的
2. **2個電荷リザーバ方式（アナログ差分）**: 高性能モジュールの場合

### 実装方法

**ケース1: モジュールがLED ON-OFF方式を使用している場合**

マイコン（Seeeduino XIAO）で以下の処理を実装します。

1. LED ON時にADCサンプリング → `V_on`
2. LED OFF時にADCサンプリング → `V_off`
3. デジタル演算で差分を計算 → `V_ppg = V_on - V_off`

**ケース2: モジュールが2個電荷リザーバ方式を使用している場合**

モジュール内部で外光除去が完了しているため、マイコンでは単純にADCサンプリングするだけで済みます。

**推奨**: まずは、モジュールのデータシートを確認し、内部回路の詳細を把握することが重要です。データシートが入手できない場合は、実験的にLED ON-OFF方式を実装し、外光除去の効果を確認してください。

---

## 参考文献

1. Jongpal Kim, Jihoon Kim, Hyoungho Ko, "Low-Power Photoplethysmogram Acquisition Integrated Circuit with Robust Light Interference Compensation," Sensors, 2015.
   - DOI: 10.3390/s16010046
   - PMCID: PMC4732079

2. 島崎拓則ら, "光電脈波計の原理を利用した適応フィルタによる運動中の心拍数センシング," 生体医工学, 2016.

3. Analog Devices, "ADPD144RI Data Sheet," 2019.

4. Maxim Integrated (Analog Devices), "MAX86177 Data Sheet," 2022.

---

## まとめ

2個フォトダイオード方式（正確には2個電荷リザーバ方式）の外光除去技術は、**LED ON-OFF方式と同じ基本原理**（時間的な差分を取る）を使用しますが、**アナログ領域で電荷再分配により実現**する点が大きく異なります。

この方式は、**低消費電力**、**高ダイナミックレンジ**、**リアルタイム処理**という利点があり、ウェアラブルデバイスに最適です。ただし、回路複雑度が増加し、電荷リザーバのマッチングとスイッチのリーク電流に注意が必要です。

本プロジェクトでは、使用予定の光学式センサーモジュールの内部回路を確認し、適切な実装方法を選択することが重要です。
