# 光学式PPGセンサーのLED ON-OFF周期 - 実装ガイド

## エグゼクティブサマリー

光学式PPGセンサーにおける外光ノイズ除去のための**最適なLED ON-OFF周期**について、学術論文と商用製品の技術資料を調査した結果、以下の推奨値が得られました。

**推奨LED ON-OFF周期**: **4～10 ms**（周波数: 100～250 Hz）

この周期は、外光ノイズ（商用電源のフリッカー、蛍光灯、LED照明）を効果的に除去しながら、心拍測定に必要な信号品質を維持し、消費電力を最小化するバランスの取れた値です。

---

## 1. LED ON-OFF周期の技術的背景

### 1.1 外光ノイズの主な原因

光学式PPGセンサーが影響を受ける外光ノイズの主な原因は以下の通りです。

**商用電源周波数（50/60 Hz）**
日本では50 Hz（東日本）または60 Hz（西日本）の商用電源周波数により、照明器具が周期的に明滅します。この周波数成分がPPG信号に混入すると、心拍測定に誤差が生じます。

**蛍光灯のフリッカー**
蛍光灯は商用電源周波数の2倍（100 Hzまたは120 Hz）で明滅します。これは、交流電源の正負両方の半サイクルで発光するためです。

**LED照明のフリッカー**
PWM（パルス幅変調）駆動のLED照明は、数百Hz～数kHzの周波数で明滅します。ただし、高品質なLED照明は高周波PWM（>1 kHz）を使用するため、PPG測定への影響は比較的小さくなります。

**太陽光**
太陽光は直流成分として作用しますが、雲の動きや手の動きにより、低周波（<1 Hz）の変動が生じます。

### 1.2 同期検波による外光除去の原理

外光ノイズを除去するため、PPGセンサーは**同期検波（Synchronous Detection）**と呼ばれる技術を使用します。その仕組みは以下の通りです。

**ステップ1: LEDをパルス駆動**
LEDを周期的にON/OFFします。ON時間とOFF時間は通常、同じ長さ（デューティサイクル50%）に設定されます。

**ステップ2: LED ON時の測定**
LEDがONの時、フォトダイオード（PD）は以下の2つの光を受信します。
- LED光が皮膚で反射した光（PPG信号）
- 外光（ノイズ）

測定値: `S_on = PPG信号 + 外光`

**ステップ3: LED OFF時の測定**
LEDがOFFの時、フォトダイオードは外光のみを受信します。

測定値: `S_off = 外光`

**ステップ4: 差分計算**
LED ON時とOFF時の測定値の差分を取ることで、外光成分を除去します。

```
PPG信号 = S_on - S_off
```

この方式により、外光の影響を大幅に低減できます。

### 1.3 LED ON-OFF周期の選択基準

LED ON-OFF周期を選択する際、以下の3つの要素をバランスさせる必要があります。

**要素1: 外光ノイズ除去能力**
- 商用電源周波数（50/60 Hz）とその高調波（100/120 Hz）を効果的に除去するため、LED ON-OFF周期はこれらの周波数より**十分に高い**必要があります。
- 推奨: **100 Hz以上**（周期10 ms以下）

**要素2: PPG信号の周波数帯域**
- 心拍数: 0.5～4 Hz（30～240 bpm）
- 呼吸数: 0.1～0.6 Hz（6～36回/分）
- LED ON-OFF周期は、PPG信号の最高周波数（4 Hz）より**十分に高い**必要があります。
- ナイキスト定理により、サンプリング周波数は信号の最高周波数の2倍以上が必要ですが、実際には**5～10倍以上**が推奨されます。
- 推奨: **20 Hz以上**（周期50 ms以下）

**要素3: 消費電力**
- LED駆動は消費電力の50%以上を占めるため、LED ON-OFF周波数が高いほど、消費電力が増加します。
- ただし、デューティサイクルを調整することで、平均消費電力を制御できます。
- 推奨: **250 Hz以下**（周期4 ms以上）

---

## 2. 調査結果: 実際のPPGセンサーで使用されている周期

### 2.1 学術論文からの知見

#### 論文1: "A Hybrid Photoplethysmography (PPG) Sensor System Design for Heart Rate Monitoring" (2024)

**LED ON-OFF周期**: 128 ms（周波数: 7.8 Hz）
- LED ON時間: 64 ms
- LED OFF時間: 64 ms
- デューティサイクル: 50%
- サンプリング周波数: 250 Hz

**評価**: この周期は**外光除去には不十分**です。商用電源周波数（50/60 Hz）より低いため、蛍光灯のフリッカー（100/120 Hz）を効果的に除去できません。ただし、この論文では外光の影響が少ない環境での測定を想定していると考えられます。

#### 論文2: "Optimizing sampling rate of wrist-worn optical sensors for physiologic monitoring" (2020)

**サンプリング周波数**: 64 Hz（周期: 15.6 ms）
- 最適サンプリング周波数: 21～64 Hz
- LEDパルス周期: 明記されていないが、サンプリング周波数と同等と推定

**評価**: 64 Hzのサンプリング周波数は、商用電源周波数（50/60 Hz）とほぼ同等であり、外光除去には**ギリギリの値**です。より高い周波数（100 Hz以上）が望ましいと考えられます。

### 2.2 商用製品からの知見

#### Analog Devices MAX86177

**外光除去能力**: 120 Hzで90 dB
- これは、LEDパルス周波数が**120 Hz以上**であることを示唆しています。
- 120 Hzは蛍光灯のフリッカー周波数（100/120 Hz）を効果的に除去できる最低限の値です。

**推定LED ON-OFF周期**: **8.3 ms以下**（120 Hz以上）

#### 一般的なウェアラブルデバイス

多くの商用ウェアラブルデバイス（Apple Watch、Fitbit、Garminなど）は、以下のサンプリング周波数を使用しています。
- **50～100 Hz**: 低消費電力モード
- **100～250 Hz**: 標準モード
- **500 Hz以上**: 医療グレードモード

これらのデバイスでは、LEDパルス周波数はサンプリング周波数と同等またはそれ以上に設定されていると推定されます。

---

## 3. 推奨LED ON-OFF周期

### 3.1 基本推奨値

調査結果を総合すると、以下の推奨値が得られます。

| 用途 | LED ON-OFF周波数 | LED ON-OFF周期 | 外光除去能力 | 消費電力 |
|------|-----------------|---------------|------------|---------|
| **標準モード（推奨）** | **100～250 Hz** | **4～10 ms** | 高い | 中程度 |
| 低消費電力モード | 50～100 Hz | 10～20 ms | 中程度 | 低い |
| 医療グレードモード | 250～500 Hz | 2～4 ms | 非常に高い | 高い |

### 3.2 具体的な実装例

#### 実装例1: 標準モード（推奨）

**LED ON-OFF周波数**: **125 Hz**
- **LED ON時間**: 4 ms
- **LED OFF時間**: 4 ms
- **合計周期**: 8 ms
- **デューティサイクル**: 50%
- **サンプリング周波数**: 125 Hz（LED ON時とOFF時にそれぞれ1回サンプリング）

**利点**:
- 商用電源周波数（50/60 Hz）とその高調波（100/120 Hz）を効果的に除去
- PPG信号の周波数帯域（0.5～4 Hz）を十分にカバー
- 消費電力と測定精度のバランスが良い

**推奨用途**: 一般的なウェアラブルデバイス、フィットネストラッカー

#### 実装例2: 高精度モード

**LED ON-OFF周波数**: **200 Hz**
- **LED ON時間**: 2.5 ms
- **LED OFF時間**: 2.5 ms
- **合計周期**: 5 ms
- **デューティサイクル**: 50%
- **サンプリング周波数**: 200 Hz

**利点**:
- より高い外光除去能力
- 高周波ノイズ（LED照明のPWMフリッカーなど）にも対応
- 心拍変動（HRV）の詳細解析が可能

**推奨用途**: 医療機器、臨床グレードのウェアラブル

#### 実装例3: 低消費電力モード

**LED ON-OFF周波数**: **50 Hz**
- **LED ON時間**: 10 ms
- **LED OFF時間**: 10 ms
- **合計周期**: 20 ms
- **デューティサイクル**: 50%
- **サンプリング周波数**: 50 Hz

**利点**:
- 消費電力が最小
- バッテリー寿命が長い

**欠点**:
- 外光除去能力が低い（商用電源周波数と同等）
- 屋内での使用には不向き

**推奨用途**: 屋外での長時間測定、バッテリー寿命優先の用途

---

## 4. 実装上の注意点

### 4.1 デューティサイクルの調整

デューティサイクル（LED ON時間の割合）は、通常**50%**に設定されますが、以下の理由で調整することがあります。

**デューティサイクルを下げる（例: 25%）**
- 消費電力を削減
- LED寿命を延ばす
- ただし、信号対ノイズ比（SNR）が低下

**デューティサイクルを上げる（例: 75%）**
- 信号対ノイズ比（SNR）を向上
- 皮膚の灌流指数（Perfusion Index）が低い場合に有効
- ただし、消費電力が増加

### 4.2 LED電流の調整

LED電流は、皮膚の色や厚さに応じて調整する必要があります。

**明るい肌**: 10～20 mA
**暗い肌**: 20～50 mA（より高い照射が必要）

LED電流が高いほど、消費電力が増加するため、デューティサイクルを下げることで補償できます。

### 4.3 サンプリングタイミング

同期検波を正確に行うため、サンプリングタイミングは以下のように設定します。

**LED ON時のサンプリング**: LED ON後、**1～2 ms待機**してからサンプリング
- LEDの立ち上がり時間（数十μs～数百μs）を考慮
- フォトダイオードの応答時間（数十μs）を考慮

**LED OFF時のサンプリング**: LED OFF後、**1～2 ms待機**してからサンプリング
- LEDの立ち下がり時間を考慮
- フォトダイオードの残光（afterglow）を考慮

### 4.4 フィルタリング

同期検波により外光の影響を大幅に低減できますが、完全には除去できません。以下のフィルタリングを追加で適用することを推奨します。

**ハイパスフィルタ**: 0.5 Hz（DCオフセットと低周波ドリフトを除去）
**ローパスフィルタ**: 5 Hz（高周波ノイズを除去）
**ノッチフィルタ**: 50/60 Hz（商用電源周波数の残留成分を除去）

---

## 5. 本プロジェクトへの推奨実装

### 5.1 使用予定の光学式センサー

**製品**: [秋月電子 光学式脈波センサー](https://akizukidenshi.com/catalog/g/g116107/)

このセンサーの詳細仕様が不明なため、以下の標準的な実装を推奨します。

### 5.2 推奨パラメータ

**LED ON-OFF周波数**: **125 Hz**
- **LED ON時間**: 4 ms
- **LED OFF時間**: 4 ms
- **合計周期**: 8 ms
- **デューティサイクル**: 50%

**サンプリング方式**:
- LED ON時に1回サンプリング（PPG信号 + 外光）
- LED OFF時に1回サンプリング（外光のみ）
- 差分を計算してPPG信号を抽出

**サンプリング周波数**: 250 Hz（LED ON/OFFそれぞれで125 Hzサンプリング）

**LED電流**: 10～30 mA（皮膚の色に応じて調整）

### 5.3 マイコン（Seeeduino XIAO）での実装

Seeeduino XIAOのタイマー機能を使用して、125 HzのLED ON-OFF制御を実装します。

**タイマー設定**:
- タイマー割り込み周波数: 250 Hz（4 ms周期）
- 奇数回の割り込み: LED ON、ADCサンプリング
- 偶数回の割り込み: LED OFF、ADCサンプリング

**ADCサンプリング**:
- Seeeduino XIAOのADC分解能: 12ビット（0～4095）
- ADCサンプリング時間: 約10 μs
- LED ON/OFF後、1 ms待機してからADCサンプリング

**データ処理**:
- LED ON時の値 - LED OFF時の値 = PPG信号
- 移動平均フィルタ（窓幅: 5サンプル）でノイズ除去
- ハイパスフィルタ（0.5 Hz）でDCオフセット除去

---

## 6. まとめ

光学式PPGセンサーにおける外光ノイズ除去のための最適なLED ON-OFF周期は、**4～10 ms（周波数: 100～250 Hz）**です。この範囲は、外光ノイズ（商用電源のフリッカー、蛍光灯、LED照明）を効果的に除去しながら、心拍測定に必要な信号品質を維持し、消費電力を最小化するバランスの取れた値です。

本プロジェクトでは、**125 Hz（周期8 ms）**のLED ON-OFF周波数を推奨します。これにより、標準的な屋内環境での外光ノイズを効果的に除去し、正確な心拍・脈波測定が可能となります。

---

## 参考文献

1. Farjana Akter Jhuma et al., "A Hybrid Photoplethysmography (PPG) Sensor System Design for Heart Rate Monitoring," Sensors, 2024.
2. Brinnae Bent and Jessilyn P Dunn, "Optimizing sampling rate of wrist-worn optical sensors for physiologic monitoring," Journal of Clinical and Translational Science, 2020.
3. Andrew Burt, "Need Clinical-Grade PPG from Your Wearable? Sometimes It Pays NOT to Shine a Light on a Problem," Analog Devices Technical Article, 2022.
4. Analog Devices, "ADPD144RI Data Sheet," 2019.
5. Maxim Integrated (Analog Devices), "MAX86177 Data Sheet," 2022.
